#!/usr/bin/env bash

# For each directory, execute a command
# Usage: ford [--exclude dir1,dir2,...] <command> [args...]

EXCLUDE_DIRS=()

# Parse exclude flag
if [[ "$1" == "--exclude" ]]; then
    IFS=',' read -ra EXCLUDE_DIRS <<< "$2"
    shift 2
fi

if [[ $# -eq 0 ]]; then
    echo "Usage: ford [--exclude dir1,dir2,...] <command> [args...]"
    echo "Executes the given command in each subdirectory of the current path"
    echo ""
    echo "Options:"
    echo "  --exclude  Comma-separated list of directories to skip"
    exit 1
fi

# Find all directories (excluding hidden directories and common ignore patterns)
for dir in */; do
    # Remove trailing slash
    dir="${dir%/}"

    # Skip if not a directory
    [[ ! -d "$dir" ]] && continue

    # Skip if in exclude list
    skip=false
    for exclude in "${EXCLUDE_DIRS[@]}"; do
        if [[ "$dir" == "$exclude" ]]; then
            skip=true
            break
        fi
    done
    [[ "$skip" == true ]] && continue

    echo "üìÇ Running command in $dir"

    if ! (cd "$dir" && "$@"); then
        echo "‚ùå Command failed (exit code: $?)"
    fi
    echo "--------------------------------------------------------------------------------"
done
