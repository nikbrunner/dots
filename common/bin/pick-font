#!/bin/bash

# pick-font - Interactive font selector for Ghostty terminal
# Uses fzf to select from predefined fonts and updates the config

set -euo pipefail

GHOSTTY_CONFIG="$HOME/repos/nikbrunner/dots/common/.config/ghostty/config"
FONTS_JSON="$HOME/fonts.json"

# Get current active font
get_current_font() {
    grep "^font-family" "$GHOSTTY_CONFIG" |
        sed 's/^font-family[[:space:]]*=[[:space:]]*//' |
        xargs
}

# Update the config with the selected font
update_font() {
    local selected_font="$1"

    # Use sed to replace the font-family value
    sed -i '' "s/^font-family[[:space:]]*=.*/font-family = ${selected_font}/" "$GHOSTTY_CONFIG"
}

main() {
    # Check if required files exist
    if [[ ! -f "$GHOSTTY_CONFIG" ]]; then
        echo "Error: Ghostty config not found at $GHOSTTY_CONFIG"
        exit 1
    fi

    if [[ ! -f "$FONTS_JSON" ]]; then
        echo "Error: Fonts JSON not found at $FONTS_JSON"
        exit 1
    fi

    # Check if fzf is available
    if ! command -v fzf &>/dev/null; then
        echo "Error: fzf is required but not installed"
        exit 1
    fi

    # Check if jq is available
    if ! command -v jq &>/dev/null; then
        echo "Error: jq is required but not installed"
        exit 1
    fi

    # Get available fonts from JSON
    fonts=$(jq -r '.[]' "$FONTS_JSON")
    current_font=$(get_current_font)

    if [[ -z "$fonts" ]]; then
        echo "No fonts found in $FONTS_JSON"
        exit 1
    fi

    # Show current font
    echo "Current font: $current_font"
    echo

    # Use fzf to select fon
    selected_font=$(echo "$fonts" | fzf \
        --border-label="┃ pick-font ┃" \
        --prompt="Select font: " \
        --header="Current: $current_font")

    if [[ -n "$selected_font" ]]; then
        if [[ "$selected_font" == "$current_font" ]]; then
            echo "Font unchanged: $selected_font"
        else
            update_font "$selected_font"
            echo "Font updated to: $selected_font"
            echo "Restart Ghostty to apply changes"
        fi
    else
        echo "No font selected"
    fi
}

main "$@"

