#!/usr/bin/env bash
# branch-picker - Interactive git branch switcher with fzf
# Usage: branch-picker [--all|-a]

set -euo pipefail

# Check if we're in a git repository
if ! git rev-parse --is-inside-work-tree &>/dev/null; then
    echo "Error: Not in a git repository" >&2
    exit 1
fi

show_all=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        -a|--all)
            show_all=true
            shift
            ;;
        *)
            echo "Usage: branch-picker [--all|-a]" >&2
            exit 1
            ;;
    esac
done

get_branches() {
    if [[ "$1" == "true" ]]; then
        git branch -a --format='%(refname:short)' | grep -v HEAD
    else
        git branch --format='%(refname:short)'
    fi
}

preview_cmd='git -c color.ui=always log -n 50 --graph --color=always --pretty=format:"%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset" {}'

# fzf with ctrl-r to toggle remote branches
target=$(get_branches "$show_all" | fzf --ansi \
    --preview-window=top:70% \
    --preview="$preview_cmd" \
    --header="Enter: checkout | Ctrl-R: toggle remotes" \
    --bind="ctrl-r:reload(if [[ '$show_all' == 'true' ]]; then git branch --format='%(refname:short)'; else git branch -a --format='%(refname:short)' | grep -v HEAD; fi)+transform-header(if [[ '$show_all' == 'true' ]]; then echo 'Enter: checkout | Ctrl-R: toggle remotes [local]'; else echo 'Enter: checkout | Ctrl-R: toggle remotes [all]'; fi)")

if [[ -n "$target" ]]; then
    # Handle remote branches (strip origin/ prefix and track)
    if [[ "$target" == origin/* ]]; then
        local_branch="${target#origin/}"
        # Check if local branch already exists
        if git show-ref --verify --quiet "refs/heads/$local_branch"; then
            git checkout "$local_branch"
        else
            git checkout --track "$target"
        fi
    else
        git checkout "$target"
    fi
fi
