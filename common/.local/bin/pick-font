#!/bin/bash

# pick-font - Interactive font selector for Ghostty terminal
# Uses fzf to select from predefined fonts and updates the config

set -euo pipefail

GHOSTTY_CONFIG="$HOME/repos/nikbrunner/dots/common/.config/ghostty/config"
ZED_CONFIG="$HOME/repos/nikbrunner/dots/common/.config/zed/settings.json"
FONTS_JSON="$HOME/repos/nikbrunner/fonts/config.json"

# Get current active font
get_current_font() {
    grep "^font-family" "$GHOSTTY_CONFIG" |
        sed 's/^font-family[[:space:]]*=[[:space:]]*//' |
        xargs
}

# Update Ghostty config with the selected font
update_ghostty_font() {
    local selected_font="$1"
    # sed -i syntax differs between macOS and Linux
    if [[ "$(uname)" == "Darwin" ]]; then
        sed -i '' "s/^font-family[[:space:]]*=.*/font-family = ${selected_font}/" "$GHOSTTY_CONFIG"
    else
        sed -i "s/^font-family[[:space:]]*=.*/font-family = ${selected_font}/" "$GHOSTTY_CONFIG"
    fi
}

# Update Zed config with the selected font
update_zed_font() {
    local selected_font="$1"
    # Update all font settings in Zed
    jq --arg font "$selected_font" '
        .ui_font_family = $font |
        .buffer_font_family = $font |
        .terminal.font_family = $font
    ' "$ZED_CONFIG" > "$ZED_CONFIG.tmp" && mv "$ZED_CONFIG.tmp" "$ZED_CONFIG"
}

# Source shared Ghostty reload function
source "$HOME/repos/nikbrunner/dots/common/.local/bin/ghostty-reload"

main() {
    # Check if required files exist
    if [[ ! -f "$GHOSTTY_CONFIG" ]]; then
        echo "Error: Ghostty config not found at $GHOSTTY_CONFIG"
        exit 1
    fi

    if [[ ! -f "$ZED_CONFIG" ]]; then
        echo "Error: Zed config not found at $ZED_CONFIG"
        exit 1
    fi

    if [[ ! -f "$FONTS_JSON" ]]; then
        echo "Error: Fonts JSON not found at $FONTS_JSON"
        exit 1
    fi

    # Check if fzf is available
    if ! command -v fzf &>/dev/null; then
        echo "Error: fzf is required but not installed"
        exit 1
    fi

    # Check if jq is available
    if ! command -v jq &>/dev/null; then
        echo "Error: jq is required but not installed"
        exit 1
    fi

    # Get available fonts from JSON
    fonts=$(jq -r '.fonts[].name' "$FONTS_JSON")
    current_font=$(get_current_font)

    if [[ -z "$fonts" ]]; then
        echo "No fonts found in $FONTS_JSON"
        exit 1
    fi

    # Show current font
    echo "Current font: $current_font"
    echo

    # Use fzf to select fon
    selected_font=$(echo "$fonts" | fzf \
        --border-label="┃ pick-font ┃" \
        --prompt="Select font: " \
        --header="Current: $current_font")

    if [[ -n "$selected_font" ]]; then
        if [[ "$selected_font" == "$current_font" ]]; then
            echo "Font unchanged: $selected_font"
        else
            # Update both Ghostty and Zed
            update_ghostty_font "$selected_font"
            update_zed_font "$selected_font"
            
            echo "Font updated to: $selected_font"
            echo "Updated configurations:"
            echo "  ✓ Ghostty"
            echo "  ✓ Zed"
            
            # Reload Ghostty automatically
            reload_ghostty
        fi
    else
        echo "No font selected"
    fi
}

main "$@"

