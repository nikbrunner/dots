#!/bin/bash

# pick-font - Interactive font selector for Ghostty terminal
# Uses fzf to select from predefined fonts and updates the config

set -euo pipefail

GHOSTTY_CONFIG="$HOME/repos/nikbrunner/dots/common/.config/ghostty/config"
ZED_CONFIG="$HOME/repos/nikbrunner/dots/common/.config/zed/settings.json"
FONTS_JSON="$HOME/repos/nikbrunner/fonts/config.json"

# Get current active font
get_current_font() {
    grep "^font-family" "$GHOSTTY_CONFIG" |
        sed 's/^font-family[[:space:]]*=[[:space:]]*//' |
        xargs
}

# Update Ghostty config with the selected font
update_ghostty_font() {
    local selected_font="$1"
    # sed -i syntax differs between macOS and Linux
    if [[ "$(uname)" == "Darwin" ]]; then
        sed -i '' "s/^font-family[[:space:]]*=.*/font-family = ${selected_font}/" "$GHOSTTY_CONFIG"
    else
        sed -i "s/^font-family[[:space:]]*=.*/font-family = ${selected_font}/" "$GHOSTTY_CONFIG"
    fi
}

# Update Ghostty config with the bold font variant
update_ghostty_bold_font() {
    local selected_font="$1"
    local bold

    # Look up bold variant from config.json
    bold=$(jq -r --arg name "$selected_font" '.fonts[] | select(.name == $name) | .bold // empty' "$FONTS_JSON")

    # Remove any existing bold config lines first
    if [[ "$(uname)" == "Darwin" ]]; then
        sed -i '' '/^font-family-bold[[:space:]]*=/d' "$GHOSTTY_CONFIG"
        sed -i '' '/^font-style-bold[[:space:]]*=/d' "$GHOSTTY_CONFIG"
    else
        sed -i '/^font-family-bold[[:space:]]*=/d' "$GHOSTTY_CONFIG"
        sed -i '/^font-style-bold[[:space:]]*=/d' "$GHOSTTY_CONFIG"
    fi

    # Skip if no bold configured
    [[ -z "$bold" ]] && return

    # Auto-detect: simple style names (Bold, SemiBold, Medium, etc.) use font-style-bold
    # Full font family names use font-family-bold
    if [[ "$bold" =~ ^(Bold|SemiBold|Medium|Regular|Light|ExtraBold|Black|Thin)$ ]]; then
        # Style name → font-style-bold
        if [[ "$(uname)" == "Darwin" ]]; then
            sed -i '' "/^font-family[[:space:]]*=/a\\
font-style-bold = ${bold}" "$GHOSTTY_CONFIG"
        else
            sed -i "/^font-family[[:space:]]*=/a font-style-bold = ${bold}" "$GHOSTTY_CONFIG"
        fi
    else
        # Full font name → font-family-bold
        if [[ "$(uname)" == "Darwin" ]]; then
            sed -i '' "/^font-family[[:space:]]*=/a\\
font-family-bold = ${bold}" "$GHOSTTY_CONFIG"
        else
            sed -i "/^font-family[[:space:]]*=/a font-family-bold = ${bold}" "$GHOSTTY_CONFIG"
        fi
    fi
}

# Update Zed config with the selected font
update_zed_font() {
    local selected_font="$1"
    # Update all font settings in Zed
    jq --arg font "$selected_font" '
        .ui_font_family = $font |
        .buffer_font_family = $font |
        .terminal.font_family = $font
    ' "$ZED_CONFIG" > "$ZED_CONFIG.tmp" && mv "$ZED_CONFIG.tmp" "$ZED_CONFIG"
}

# Source shared Ghostty reload function
source "$HOME/repos/nikbrunner/dots/common/.local/bin/ghostty-reload"

main() {
    # Check if required files exist
    if [[ ! -f "$GHOSTTY_CONFIG" ]]; then
        echo "Error: Ghostty config not found at $GHOSTTY_CONFIG"
        exit 1
    fi

    if [[ ! -f "$ZED_CONFIG" ]]; then
        echo "Error: Zed config not found at $ZED_CONFIG"
        exit 1
    fi

    if [[ ! -f "$FONTS_JSON" ]]; then
        echo "Error: Fonts JSON not found at $FONTS_JSON"
        exit 1
    fi

    # Check if fzf is available
    if ! command -v fzf &>/dev/null; then
        echo "Error: fzf is required but not installed"
        exit 1
    fi

    # Check if jq is available
    if ! command -v jq &>/dev/null; then
        echo "Error: jq is required but not installed"
        exit 1
    fi

    # Get available fonts from JSON (label -> name mapping)
    current_font=$(get_current_font)

    # Get current label from name
    current_label=$(jq -r --arg name "$current_font" '.fonts[] | select(.name == $name) | .label // .name' "$FONTS_JSON")

    # Get all labels for fzf display
    labels=$(jq -r '.fonts[].label' "$FONTS_JSON")

    if [[ -z "$labels" ]]; then
        echo "No fonts found in $FONTS_JSON"
        exit 1
    fi

    # Show current font
    echo "Current font: $current_label"
    echo

    # Use fzf to select font by label
    selected_label=$(echo "$labels" | fzf \
        --border-label="┃ pick-font ┃" \
        --prompt="Select font: " \
        --header="Current: $current_label")

    # Get the actual font name from the selected label
    selected_font=$(jq -r --arg label "$selected_label" '.fonts[] | select(.label == $label) | .name' "$FONTS_JSON")

    if [[ -n "$selected_font" && "$selected_font" != "null" ]]; then
        if [[ "$selected_font" == "$current_font" ]]; then
            echo "Font unchanged: $selected_label"
        else
            # Update both Ghostty and Zed
            update_ghostty_font "$selected_font"
            update_ghostty_bold_font "$selected_font"
            update_zed_font "$selected_font"

            echo "Font updated to: $selected_label"
            echo "Updated configurations:"
            echo "  ✓ Ghostty (regular + bold)"
            echo "  ✓ Zed"

            # Reload Ghostty automatically
            reload_ghostty
        fi
    else
        echo "No font selected"
    fi
}

main "$@"

