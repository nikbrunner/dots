# Vim integration
IS_VIM="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?|fzf)(diff)?$'"

# Application Integration (CTRL - vim navigation)
bind-key -n C-h if-shell "$IS_VIM" "send-keys C-h"  "select-pane -L"
bind-key -n C-j if-shell "$IS_VIM" "send-keys C-j"  "select-pane -D"
bind-key -n C-k if-shell "$IS_VIM" "send-keys C-k"  "select-pane -U" 
bind-key -n C-l if-shell "$IS_VIM" "send-keys C-l"  "select-pane -R"

# Display popups
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ Popup Cheat Sheet                                                           │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │ Size:     -w50% -h35%           (percentage)                                │
# │           -w80 -h15             (columns/rows)                              │
# │                                                                             │
# │ Position: -xC -yC               (center - default)                          │
# │           -x0 -y0               (top-left)                                  │
# │           -x "#{e|/:#{window_width},2}" -y0   (top-right, dynamic)          │
# │                                                                             │
# │ Style:    -s "bg=#1a1b26"       (popup background)                          │
# │           -S "bg=#1a1b26"       (border background)                         │
# │           -s "bg=black,fg=white"                                            │
# │                                                                             │
# │ Other:    -B                    (borderless)                                │
# │           -d "#{pane_current_path}"  (working directory)                    │
# │           -E                    (close on exit)                             │
# └─────────────────────────────────────────────────────────────────────────────┘
bind -n M-m display-popup -d "#{pane_current_path}" -w90% -h90% -E "rmpc"
bind -n M-b display-popup -d "#{pane_current_path}" -w90% -h90% -E "bm"

# bind -n M-g display-popup -d "#{pane_current_path}" -w95% -h95% -E "lazygit"
# bind -n M-D display-popup -d "#{pane_current_path}" -w95% -h95% -E "lazydocker"
bind -n M-D display-popup -d "#{pane_current_path}" -w90% -h90% -B -E "tmux-file-picker -g"


bind -n M-T display-popup -d "#{pane_current_path}" -w50% -h35% -B -E "dots theme"
bind -n M-F display-popup -d "#{pane_current_path}" -w50% -h35% -B -E "dots font"

# Version Control key table (prefix + v + ...)
bind g {
    switch-client -T version-control
    display-message -d 20000 "Version Control (c=[C]ontrol, b=[B]ranches, w=[W]orktreee)"
}

bind -T version-control s display-popup -d "#{pane_current_path}" -w95% -h95% -E "lazygit"
bind -T version-control b display-popup -d "#{pane_current_path}" -w65% -h65% -B -E "branch-picker"
bind -T version-control w display-popup -d "#{pane_current_path}" -w65% -h65% -B -E "gwt"

# Persistent popup shell (Alt-t to toggle, preserves state)
bind -n M-t display-popup -d "#{pane_current_path}" -w90% -h90% -E "~/.config/tmux/scripts/show-popup.sh"

# Projects & Workspaces (Sessions in tmux)
bind -n M-s display-popup -w125 -h20 -E -B "tsm"
bind -n M-S display-popup -w65% -h35% -B -E "repos open"

# Last window or session
bind -n M-o last-window
bind -n M-O switch-client -l

# Session selection
bind -n M-) run-shell "repos open nikbrunner/dots"

bind -n M-! run-shell "repos open nikbrunner/notes"
bind -n M-@ run-shell "repos open nikbrunner/dcd-notes"
bind -n M-# run-shell "repos open nikbrunner/scarth-johnson"

bind -n M-$ run-shell "repos open black-atom-industries/core"
bind -n M-% run-shell "repos open black-atom-industries/nvim"
bind -n M-^ run-shell "repos open black-atom-industries/radar.nvim"

bind -n M-& run-shell "repos open nikbrunner/nbr.haus"
bind -n M-* run-shell "repos open nikbrunner/koyo"
bind -n M-( run-shell "repos open dealercenter-digital/bc-desktop-client"

# Window Selection Alt-Shift-<number>
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

bind -n M-h previous-window
bind -n M-l next-window
bind -n M-Q kill-window

# Pane Management (Splits) - Alt+Shift (using uppercase for tmux compatibility)
bind l split-window -h -c '#{pane_current_path}'
bind j split-window -v -c '#{pane_current_path}'

# Window Movement (equivalent to MoveTabRelative)
bind -n M-, swap-window -t -1 \; previous-window
bind -n M-. swap-window -t +1 \; next-window

bind -n M-S-Left resize-pane -L 5
bind -n M-S-Down resize-pane -D 5
bind -n M-S-Up resize-pane -U 5
bind -n M-S-Right resize-pane -R 5

bind -n M-z resize-pane -Z
bind -n M-q kill-pane

# Naming (using LEADER prefix)
bind n command-prompt -p "Rename window:" "rename-window '%%'"
bind N command-prompt -p "Rename session:" "rename-session '%%'"

# Layout reset (fixes proportions after terminal resize)
bind L run-shell "~/.config/tmux/layouts/reset-ide.sh"

